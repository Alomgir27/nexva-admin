(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[982],{84508:function(e,t,r){Promise.resolve().then(r.bind(r,30659))},30659:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return d}});var a=r(57437),s=r(2265),n=r(99376),o=r(23488);let l=(0,r(8301).Z)("CheckCircle2",[["path",{d:"M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",key:"14v8dr"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);var c=r(80498),i=r(66754);function d(){let e=(0,n.useRouter)(),[t,r]=(0,s.useState)([]),[d,u]=(0,s.useState)(null),[x,b]=(0,s.useState)(null),[p,h]=(0,s.useState)(!0),[m,g]=(0,s.useState)("open"),[v,f]=(0,s.useState)(""),[y,k]=(0,s.useState)(!1),j=(0,s.useRef)(null),S=(0,s.useRef)(null);(0,s.useEffect)(()=>{if(!localStorage.getItem("token")){e.push("/login");return}w();let t=setInterval(w,3e4);return()=>clearInterval(t)},[m]),(0,s.useEffect)(()=>(d&&(_(d),N(d)),()=>{S.current&&(S.current.close(),S.current=null)}),[d]);let N=e=>{S.current&&S.current.close();let t="https:"===window.location.protocol?"wss:":"ws:",r="".concat(t,"//localhost:8000/ws/support/").concat(e,"?support_email=support@nexva.ai");console.log("[Support WS] Connecting to:",r),S.current=new WebSocket(r),S.current.onopen=()=>{console.log("[Support WS] ✅ Connected to ticket",e)},S.current.onmessage=t=>{let r=JSON.parse(t.data);console.log("[Support WS] Message received:",r),"message"===r.type&&_(e)},S.current.onerror=e=>{console.error("[Support WS] ❌ Error:",e)},S.current.onclose=()=>{console.log("[Support WS] Disconnected")}};(0,s.useEffect)(()=>{var e;null===(e=j.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[null==x?void 0:x.messages]);let w=async()=>{try{let t=localStorage.getItem("token"),a=await fetch("all"===m?"http://localhost:8000/api/support/tickets":"http://localhost:8000/api/support/tickets?status=".concat(m),{headers:{Authorization:"Bearer ".concat(t)}});if(401===a.status){localStorage.removeItem("token"),e.push("/login");return}if(a.ok){let e=await a.json();r(e)}}catch(e){console.error("Failed to fetch tickets",e)}finally{h(!1)}},_=async e=>{try{let t=localStorage.getItem("token"),r=await fetch("http://localhost:8000/api/support/tickets/".concat(e),{headers:{Authorization:"Bearer ".concat(t)}});if(r.ok){let e=await r.json();b(e)}}catch(e){console.error("Failed to fetch ticket detail",e)}},C=async()=>{if(v.trim()&&d&&x){k(!0);try{if(S.current&&S.current.readyState===WebSocket.OPEN)console.log("[Support WS] Sending message via WebSocket"),S.current.send(JSON.stringify({message:v.trim()})),f(""),setTimeout(()=>_(d),200);else{console.log("[Support API] WebSocket not ready, using REST API");let e=localStorage.getItem("token");(await fetch("http://localhost:8000/api/support/tickets/".concat(d,"/message"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({message:v,sender_email:"support@nexva.ai"})})).ok&&(f(""),_(d))}}catch(e){console.error("Failed to send message",e)}finally{k(!1)}}},Z=async()=>{if(d)try{let e=localStorage.getItem("token");(await fetch("http://localhost:8000/api/tickets/".concat(d,"/resolve"),{method:"POST",headers:{Authorization:"Bearer ".concat(e)}})).ok&&(w(),_(d))}catch(e){console.error("Failed to resolve ticket",e)}},P=e=>{switch(e){case"open":return"bg-yellow-500";case"in_progress":return"bg-blue-500";case"resolved":return"bg-green-500";default:return"bg-gray-500"}},z=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),D=e=>{let t=new Date(e),r=new Date,a=new Date(r);return(a.setDate(a.getDate()-1),t.toDateString()===r.toDateString())?"Today":t.toDateString()===a.toDateString()?"Yesterday":t.toLocaleDateString([],{month:"short",day:"numeric"})};return p?(0,a.jsx)("div",{className:"h-screen flex items-center justify-center",children:(0,a.jsx)(o.Z,{className:"h-8 w-8 animate-spin text-[var(--text-text-tertiary)]"})}):(0,a.jsxs)("div",{className:"h-screen flex flex-col bg-[var(--bg-bg-base-default)]",children:[(0,a.jsx)("div",{className:"border-b border-[var(--border-border-neutral-l1)] bg-[var(--bg-bg-base-secondary)] px-6 py-4",children:(0,a.jsx)("h1",{className:"text-2xl font-semibold text-[var(--text-text-default)]",children:"Support Tickets"})}),(0,a.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,a.jsxs)("div",{className:"w-96 border-r border-[var(--border-border-neutral-l1)] bg-[var(--bg-bg-base-secondary)] flex flex-col",children:[(0,a.jsx)("div",{className:"p-4 border-b border-[var(--border-border-neutral-l1)]",children:(0,a.jsx)("div",{className:"flex space-x-1",children:["all","open","in_progress","resolved"].map(e=>(0,a.jsx)("button",{onClick:()=>g(e),className:"flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all capitalize ".concat(m===e?"bg-[var(--bg-bg-brand)] text-[var(--text-text-onbrand)]":"text-[var(--text-text-secondary)] hover:bg-[var(--bg-bg-overlay-l1)]"),children:e.replace("_"," ")},e))})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:t.map(e=>(0,a.jsxs)("div",{onClick:()=>u(e.id),className:"p-4 border-b border-[var(--border-border-neutral-l1)] cursor-pointer transition-colors ".concat(d===e.id?"bg-[var(--bg-bg-overlay-l1)]":"hover:bg-[var(--bg-bg-overlay-l1)]"),children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(P(e.status))}),(0,a.jsx)("span",{className:"font-medium text-[var(--text-text-default)] text-sm",children:e.chatbot_name})]}),(0,a.jsx)("span",{className:"text-xs text-[var(--text-text-tertiary)]",children:D(e.created_at)})]}),(0,a.jsx)("p",{className:"text-sm text-[var(--text-text-secondary)] line-clamp-2",children:e.last_message})]},e.id))})]}),(0,a.jsx)("div",{className:"flex-1 flex flex-col bg-[var(--bg-bg-base-default)]",children:d&&x?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"border-b border-[var(--border-border-neutral-l1)] bg-[var(--bg-bg-base-secondary)] px-6 py-4 flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h2",{className:"font-semibold text-[var(--text-text-default)]",children:["Ticket #",x.ticket.id]}),(0,a.jsx)("p",{className:"text-sm text-[var(--text-text-secondary)]",children:x.ticket.chatbot_name})]}),"resolved"!==x.ticket.status&&(0,a.jsxs)("button",{onClick:Z,className:"flex items-center space-x-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all",children:[(0,a.jsx)(l,{className:"h-4 w-4"}),(0,a.jsx)("span",{children:"Resolve"})]})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[x.messages.map(e=>(0,a.jsx)("div",{className:"flex ".concat("support"===e.sender_type?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-md px-4 py-2 rounded-lg ".concat("support"===e.sender_type?"bg-[var(--bg-bg-brand)] text-[var(--text-text-onbrand)]":"bg-[var(--bg-bg-overlay-l1)] text-[var(--text-text-default)]"),children:[(0,a.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),(0,a.jsx)("p",{className:"text-xs mt-1 opacity-70",children:z(e.created_at)})]})},e.id)),(0,a.jsx)("div",{ref:j})]}),"resolved"!==x.ticket.status&&(0,a.jsx)("div",{className:"border-t border-[var(--border-border-neutral-l1)] bg-[var(--bg-bg-base-secondary)] p-4",children:(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("input",{type:"text",value:v,onChange:e=>f(e.target.value),onKeyPress:e=>"Enter"===e.key&&!y&&C(),placeholder:"Type your message...",className:"flex-1 px-4 py-2 bg-[var(--bg-bg-base-default)] border border-[var(--border-border-neutral-l1)] rounded-lg text-[var(--text-text-default)] focus:outline-none focus:border-[var(--bg-bg-brand)]"}),(0,a.jsx)("button",{onClick:C,disabled:y||!v.trim(),className:"px-6 py-2 bg-[var(--bg-bg-brand)] text-[var(--text-text-onbrand)] rounded-lg hover:bg-[var(--bg-bg-brand-hover)] disabled:opacity-50 transition-all flex items-center space-x-2",children:y?(0,a.jsx)(o.Z,{className:"h-5 w-5 animate-spin"}):(0,a.jsx)(c.Z,{className:"h-5 w-5"})})]})})]}):(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(i.Z,{className:"h-16 w-16 text-[var(--text-text-tertiary)] mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-[var(--text-text-secondary)]",children:"Select a ticket to view conversation"})]})})})]})]})}},99376:function(e,t,r){"use strict";var a=r(35475);r.o(a,"usePathname")&&r.d(t,{usePathname:function(){return a.usePathname}}),r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}}),r.o(a,"useSearchParams")&&r.d(t,{useSearchParams:function(){return a.useSearchParams}})},8301:function(e,t,r){"use strict";r.d(t,{Z:function(){return o}});var a=r(2265),s={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let n=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase();var o=(e,t)=>{let r=(0,a.forwardRef)((r,o)=>{let{color:l="currentColor",size:c=24,strokeWidth:i=2,absoluteStrokeWidth:d,children:u,...x}=r;return(0,a.createElement)("svg",{ref:o,...s,width:c,height:c,stroke:l,strokeWidth:d?24*Number(i)/Number(c):i,className:"lucide lucide-".concat(n(e)),...x},[...t.map(e=>{let[t,r]=e;return(0,a.createElement)(t,r)}),...(Array.isArray(u)?u:[u])||[]])});return r.displayName="".concat(e),r}},23488:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(8301).Z)("Loader",[["line",{x1:"12",x2:"12",y1:"2",y2:"6",key:"gza1u7"}],["line",{x1:"12",x2:"12",y1:"18",y2:"22",key:"1qhbu9"}],["line",{x1:"4.93",x2:"7.76",y1:"4.93",y2:"7.76",key:"xae44r"}],["line",{x1:"16.24",x2:"19.07",y1:"16.24",y2:"19.07",key:"bxnmvf"}],["line",{x1:"2",x2:"6",y1:"12",y2:"12",key:"89khin"}],["line",{x1:"18",x2:"22",y1:"12",y2:"12",key:"pb8tfm"}],["line",{x1:"4.93",x2:"7.76",y1:"19.07",y2:"16.24",key:"1uxjnu"}],["line",{x1:"16.24",x2:"19.07",y1:"7.76",y2:"4.93",key:"6duxfx"}]])},66754:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(8301).Z)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]])},80498:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(8301).Z)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]])}},function(e){e.O(0,[971,117,744],function(){return e(e.s=84508)}),_N_E=e.O()}]);